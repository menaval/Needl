<div id="map"></div>

<% content_for(:after_js) do %>
<%= javascript_include_tag "https://maps.google.com/maps/api/js?sensor=false&key=AIzaSyCOmsyWHOongAOfaB1f8iHk3CY7XVuUBs0" %>
<%= javascript_include_tag "https://google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js" %>

  <script>

    var mapStyle =[{"featureType":"landscape.man_made","elementType":"all","stylers":[{"color":"#949191"},{"lightness":83},{"saturation":"7"}]},{"featureType":"landscape.natural","elementType":"geometry.fill","stylers":[{"lightness":77}]},{"featureType":"poi.park","elementType":"geometry.fill","stylers":[{"color":"#34ad6b"},{"lightness":"40"}]},{"featureType":"poi.school","elementType":"geometry.fill","stylers":[{"lightness":"39"},{"gamma":"0.76"},{"hue":"#fff700"},{"saturation":"67"}]},{"featureType":"poi.sports_complex","elementType":"geometry.fill","stylers":[{"color":"#c15e1f"},{"lightness":"12"},{"saturation":"45"},{"gamma":"2.07"}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#f1b127"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"color":"#2f78c4"},{"gamma":"1.50"},{"lightness":"12"}]}]

  $(document).on('ready', function() {
    function initialize(){

      var mapOptions = {
        zoom: 14,
        disableDefaultUI: true,
        styles: mapStyle
      };

      var map = new google.maps.Map(document.getElementById('map'), mapOptions);

      var markers_json = <%= raw @markers.to_json %>;
      var markerBounds = new google.maps.LatLngBounds();
      var infowindow = new google.maps.InfoWindow({
        content: ''
      });

      function addListenerToDisplayInfoWindow (marker, index) {
         google.maps.event.addListener(marker, 'click', function () {
             $.ajax( {
               url: '/restaurants/'+ markers_json[index].restaurant_id +'/map_box'
             }).done (function(data){

               infowindow.setContent(data);
               infowindow.open(map,marker);
             });

             mixpanel.track("restaurant_box", {
               user: "<%= current_user.name %>",
               browser: "<%= browser.name %>"
             });

           });
      }

      var marker;
      var marker_position;
      // var image = {
      //   url: <%=asset_path('images/quote-end.png')%>,
      //   size: new google.maps.Size(20, 32),
      //   origin: new google.maps.Point(0,0)
      // };
      for (var i = 0; i < markers_json.length; i++) {
        marker_position = new google.maps.LatLng(markers_json[i].lat,markers_json[i].lng);
        marker = new google.maps.Marker ({
          position: marker_position,
          map: map
          // icon: image
        });
        addListenerToDisplayInfoWindow(marker, i);
        markerBounds.extend(marker_position);
      }
      map.fitBounds(markerBounds);
    }
    google.maps.event.addDomListener(window, 'load', initialize);
  });

  </script>

<% end %>

